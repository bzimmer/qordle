# https://taskfile.dev

version: '3'

dotenv: [".clean.env"]

vars:
  CWD:
    sh: git rev-parse --show-toplevel
  APP:
    sh: basename {{.CWD}}
  PKG:
    github.com/bzimmer/{{.APP}}
  DIST:
    "{{.CWD}}/dist"
  COMMIT:
    sh: git rev-parse --short HEAD

tasks:
  default:
    cmds:
      - task: build

  dist:
    desc: Create dist directory
    cmds:
      - mkdir -p {{.DIST}}

  test:
    desc: Run unit tests
    deps: [dist]
    cmds:
      # https://github.com/golang/go/issues/49138
      - go test {{.CLI_ARGS}} -timeout 20s -race -count=1 -covermode atomic -coverprofile {{.DIST}}/coverage.txt {{.PKG}}

  test:regression:
    desc: Run regression test
    deps: [build]
    cmds:
      - "{{.CWD}}/bin/regression.zsh"
      - "{{.CWD}}/bin/analyze.zsh"

  fuzz:
    desc: Run fuzz tests
    cmds:
      - go test -fuzz=Fuzz{{.CLI_ARGS}} -fuzztime 10s

  cover:
    desc: Visualize test coverage
    deps: [test]
    cmds:
      - go tool cover -html={{.DIST}}/coverage.txt

  clean:
    desc: Remove build artifacts
    cmds:
      - rm -rf {{.DIST}}

  build:
    desc: Build all cmds
    deps: [dist]
    cmds:
      - go build -o {{.DIST}}/{{.APP}} cmd/{{.APP}}/*.go
      - go build -o {{.DIST}}/{{.APP}}d cmd/{{.APP}}d/*.go

  lint:
    desc: Runs golint
    cmds:
      - golangci-lint -v run
      - typos

  snapshot:
    desc: Build a snapshot
    deps: [test, lint]
    cmds:
      - goreleaser --debug release --snapshot --clean

  qordled:
    desc: Run qordled
    deps: [build]
    env:
      BASE_URL: http://localhost:8091/qordle
    cmds:
      - "{{.DIST}}/qordled --port 8091"

  scc:
    desc: Run scc (https://github.com/boyter/scc)
    cmds:
      - scc -i go {{.CWD}}

  goimports:
    desc: Run goimports
    vars:
      Module:
        sh: go mod edit -json | jq -r .Module.Path
    cmds:
      - goimports -w -local "{{.Module}}" .

  hyperfine:
    desc: Run hyperfine
    deps: [build]
    vars:
      binaries:
        ./dist/qordle,/opt/homebrew/bin/qordle
      options:
        -S -w solutions -w possible
      secrets:
        mound board brain lills qwert 12345
    cmds:
      - |
        hyperfine -N -w 3 --runs=75 -L binary {{.binaries}} "{binary} play {{.options}} {{.secrets}}"

  profile:
    desc: Run the profiler
    cmds:
      - go test -outputdir {{.DIST}} -cpuprofile cpu.prof -memprofile mem.prof -bench .
      - go tool pprof -http=":8000" ./qordle.test {{.DIST}}/mem.prof

  books:
    desc: Generate the google books data structures
    cmds:
      - python3 {{.CWD}}/bin/norvig.py > {{.CWD}}/books.go
      - task: goimports
